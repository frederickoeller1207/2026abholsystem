<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin-Verwaltung Abholung</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
      body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 p-4">

    <div id="root" class="container mx-auto">
        <!-- Die React-App wird hier gerendert -->
    </div>

    <script type="module">
        import React, { useState, useEffect } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, updateDoc, deleteDoc, addDoc, getDocs, where, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { format, isToday, isBefore, parseISO } from 'https://esm.sh/date-fns@2.30.0';
        import { de } from 'https://esm.sh/date-fns@2.30.0/locale/de';

        const firebaseConfig = {
            apiKey: "AIzaSyAYf7wZxI7szM2jdpelENIvVrDHE25M0Jc",
            authDomain: "neuabholung.firebaseapp.com",
            databaseURL: "https://neuabholung-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "neuabholung",
            storageBucket: "neuabholung.firebasestorage.app",
            messagingSenderId: "982992894873",
            appId: "1:982992894873:web:750e72ee79f585c1717108"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const containerClass = "container mx-auto p-4 bg-gray-100 min-h-screen font-sans";
        const cardClass = "bg-white p-6 rounded-xl shadow-md my-4";
        const buttonClass = "bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full transition-colors duration-200";
        const inputClass = "w-full p-2 border border-gray-300 rounded-md mt-1 mb-2";
        const tableClass = "min-w-full divide-y divide-gray-200 mt-4";
        const thClass = "px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider";
        const tdClass = "px-6 py-4 whitespace-nowrap text-sm text-gray-900";
        const trClass = "bg-white even:bg-gray-50";

        const App = () => {
            const [children, setChildren] = useState([]);
            const [pickupTimes, setPickupTimes] = useState({});
            const [oneTimePickupTimes, setOneTimePickupTimes] = useState({});
            const [loading, setLoading] = useState(true);
            const [authReady, setAuthReady] = useState(false);
            const [userId, setUserId] = useState('');
            const [message, setMessage] = useState('');
            const [newChildName, setNewChildName] = useState('');
            const [editChild, setEditChild] = useState(null);
            const [editPickupTimes, setEditPickupTimes] = useState({});
            const [editOneTimePickupTimes, setEditOneTimePickupTimes] = useState({ date: '', times: {} });
            const [absentees, setAbsentees] = useState([]);
            const [selectedAbsenceDate, setSelectedAbsenceDate] = useState('');

            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Fehler bei der Anmeldung:", error);
                    }
                };
                initAuth();

                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    if (user) {
                        setUserId(user.uid);
                        setAuthReady(true);
                    } else {
                        setAuthReady(true);
                    }
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!authReady || !userId) return;

                const childrenPath = `/artifacts/${appId}/users/${userId}/children`;
                const pickupTimesPath = `/artifacts/${appId}/users/${userId}/pickupTimes`;
                const oneTimePickupTimesPath = `/artifacts/${appId}/users/${userId}/oneTimePickupTimes`;

                const unsubscribeChildren = onSnapshot(collection(db, childrenPath), (snapshot) => {
                    const childrenData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setChildren(childrenData);
                }, (error) => console.error("Fehler beim Laden der Kinder:", error));

                const unsubscribePickupTimes = onSnapshot(collection(db, pickupTimesPath), (snapshot) => {
                    const timesData = {};
                    snapshot.docs.forEach(doc => {
                        timesData[doc.id] = doc.data().times;
                    });
                    setPickupTimes(timesData);
                    setEditPickupTimes(timesData);
                }, (error) => console.error("Fehler beim Laden der Abholzeiten:", error));
                
                const unsubscribeOneTimePickupTimes = onSnapshot(collection(db, oneTimePickupTimesPath), (snapshot) => {
                    const oneTimeTimesData = {};
                    snapshot.docs.forEach(doc => {
                      oneTimeTimesData[doc.id] = doc.data().times;
                    });
                    setOneTimePickupTimes(oneTimeTimesData);
                    setLoading(false);
                }, (error) => console.error("Fehler beim Laden der einmaligen Abholzeiten:", error));
                
                return () => {
                    unsubscribeChildren();
                    unsubscribePickupTimes();
                    unsubscribeOneTimePickupTimes();
                };
            }, [authReady, userId]);

            const addChild = async (name) => {
                if (!name) {
                    setMessage('Der Name des Kindes darf nicht leer sein.');
                    return;
                }
                const childrenPath = `/artifacts/${appId}/users/${userId}/children`;
                await addDoc(collection(db, childrenPath), { name, status: 'anwesend' });
                setMessage('Kind erfolgreich hinzugefügt.');
                setNewChildName('');
            };

            const updateChild = async (id, name, status) => {
                if (!name) {
                    setMessage('Der Name des Kindes darf nicht leer sein.');
                    return;
                }
                const docRef = doc(db, `/artifacts/${appId}/users/${userId}/children`, id);
                await updateDoc(docRef, { name, status });
                setMessage('Kind erfolgreich aktualisiert.');
            };

            const deleteChild = async (id) => {
                const docRef = doc(db, `/artifacts/${appId}/users/${userId}/children`, id);
                await deleteDoc(docRef);
                setMessage('Kind erfolgreich gelöscht.');
            };

            const updatePickupTimes = async (weekday, times) => {
                const docRef = doc(db, `/artifacts/${appId}/users/${userId}/pickupTimes`, weekday);
                await setDoc(docRef, { times });
                setMessage('Abholzeiten erfolgreich aktualisiert.');
            };

            const updateOneTimePickupTimes = async () => {
                if (!editOneTimePickupTimes.date) {
                    setMessage('Datum darf nicht leer sein.');
                    return;
                }
                const docRef = doc(db, `/artifacts/${appId}/users/${userId}/oneTimePickupTimes`, editOneTimePickupTimes.date);
                await setDoc(docRef, { times: editOneTimePickupTimes.times });
                setMessage('Einmalige Abholzeiten erfolgreich gespeichert.');
            };

            const deleteOneTimePickupTimes = async (date) => {
                const docRef = doc(db, `/artifacts/${appId}/users/${userId}/oneTimePickupTimes`, date);
                await deleteDoc(docRef);
                setMessage('Einmalige Abholzeiten für dieses Datum erfolgreich gelöscht.');
            };

            const handlePickupTimeChange = (weekday, childName, time) => {
                setEditPickupTimes(prev => ({
                    ...prev,
                    [weekday]: {
                        ...prev[weekday],
                        [childName]: time
                    }
                }));
            };

            const handleOneTimePickupTimeChange = (childName, time) => {
                setEditOneTimePickupTimes(prev => ({
                    ...prev,
                    times: {
                        ...prev.times,
                        [childName]: time
                    }
                }));
            };

            const getAbsentees = async () => {
                if (!selectedAbsenceDate) {
                    setMessage('Bitte wählen Sie ein Datum aus.');
                    return;
                }
                
                const allChildren = children.map(c => c.name);
                const querySnapshot = await getDocs(collection(db, `/artifacts/${appId}/users/${userId}/abgemeldete`));
                const abgemeldete = querySnapshot.docs.map(doc => doc.data());
                
                const absenteesOnDate = allChildren.filter(childName => {
                    return !abgemeldete.some(entry => entry.name === childName && format(parseISO(entry.abgemeldetAm), 'yyyy-MM-dd') === selectedAbsenceDate);
                });
                
                setAbsentees(absenteesOnDate);
                setMessage(`Anwesenheitsliste für ${selectedAbsenceDate} geladen.`);
            };

            const deleteAbsenteeEntry = async (name) => {
                // To be implemented later, as the current structure does not store "absent" records, but rather "signed out"
                setMessage('Das Löschen von Anwesenheitseinträgen ist in dieser Version nicht verfügbar, da Anwesenheit dynamisch berechnet wird. Es werden nur die Abmeldungen gespeichert.');
            };

            const getChildLink = (child) => {
                const url = new URL(window.location.href);
                url.pathname = 'child.html';
                url.searchParams.set('name', child.name);
                url.searchParams.set('id', child.id);
                return url.toString();
            };

            if (loading || !authReady) {
                return <div className="text-center text-gray-500 text-lg mt-8">Lade Daten...</div>;
            }

            return (
                <div className={containerClass}>
                    <h1 className="text-3xl font-bold text-center mb-6 text-gray-800">Admin-Verwaltung</h1>
                    <p className="text-center text-sm text-gray-600 mb-4">Ihre User-ID: <code className="bg-gray-200 p-1 rounded-md">{userId}</code></p>
                    
                    {message && <div className="bg-green-200 text-green-800 p-3 rounded-md mb-4 text-center">{message}</div>}

                    <div className={cardClass}>
                        <h2 className="text-xl font-semibold mb-4">Kinder verwalten</h2>
                        <div className="flex gap-2">
                            <input
                                type="text"
                                value={newChildName}
                                onChange={(e) => setNewChildName(e.target.value)}
                                placeholder="Neues Kind hinzufügen"
                                className={inputClass}
                            />
                            <button onClick={() => addChild(newChildName)} className={buttonClass}>Hinzufügen</button>
                        </div>
                        <button onClick={async () => {
                             const q = collection(db, `/artifacts/${appId}/users/${userId}/children`);
                             const querySnapshot = await getDocs(q);
                             const batchUpdates = querySnapshot.docs.map(docSnapshot => {
                                 const docRef = doc(db, `/artifacts/${appId}/users/${userId}/children`, docSnapshot.id);
                                 return updateDoc(docRef, { status: 'anwesend', abgemeldetAm: null });
                             });
                             await Promise.all(batchUpdates);
                             setMessage('Alle Kinderstatus wurden zurückgesetzt.');
                        }} className={`${buttonClass} mt-4 bg-red-500 hover:bg-red-600`}>Status zurücksetzen</button>
                        
                        <table className={tableClass}>
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className={thClass}>Name</th>
                                    <th className={thClass}>Abmeldelink</th>
                                    <th className={thClass}>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {children.map((child) => (
                                    <tr key={child.id} className={trClass}>
                                        <td className={tdClass}>{child.name}</td>
                                        <td className={tdClass}>
                                            <a href={getChildLink(child)} target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:underline">
                                                Link für {child.name}
                                            </a>
                                        </td>
                                        <td className={tdClass}>
                                            <button onClick={() => setEditChild(child)} className="text-indigo-600 hover:text-indigo-900 mr-2">Bearbeiten</button>
                                            <button onClick={() => deleteChild(child.id)} className="text-red-600 hover:text-red-900">Löschen</button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        
                        {editChild && (
                            <div className="mt-4 p-4 border border-gray-200 rounded-md bg-gray-50">
                                <h3 className="font-semibold mb-2">Kind bearbeiten</h3>
                                <input
                                    type="text"
                                    defaultValue={editChild.name}
                                    onChange={(e) => setEditChild({ ...editChild, name: e.target.value })}
                                    className={inputClass}
                                />
                                <button onClick={() => { updateChild(editChild.id, editChild.name); setEditChild(null); }} className={buttonClass}>Speichern</button>
                                <button onClick={() => setEditChild(null)} className="ml-2 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-full transition-colors duration-200">Abbrechen</button>
                            </div>
                        )}
                    </div>

                    <div className={cardClass}>
                        <h2 className="text-xl font-semibold mb-4">Anwesenheitsliste</h2>
                        <div className="flex gap-2 mb-4">
                            <input
                                type="date"
                                value={selectedAbsenceDate}
                                onChange={(e) => setSelectedAbsenceDate(e.target.value)}
                                className={inputClass}
                            />
                            <button onClick={getAbsentees} className={buttonClass}>Anwesenheit prüfen</button>
                        </div>
                        {absentees.length > 0 && (
                            <div>
                                <h3 className="font-semibold text-lg">Anwesende Kinder am {format(new Date(selectedAbsenceDate), 'dd.MM.yyyy')}</h3>
                                <ul className="list-disc list-inside mt-2">
                                    {absentees.map(name => (
                                        <li key={name} className="text-gray-700">{name}</li>
                                    ))}
                                </ul>
                            </div>
                        )}
                    </div>
                    
                    <div className={cardClass}>
                        <h2 className="text-xl font-semibold mb-4">Reguläre Abholzeiten verwalten</h2>
                        {['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag'].map(weekday => (
                            <div key={weekday} className="border-b border-gray-200 mb-4 pb-4 last:border-b-0">
                                <h3 className="font-semibold text-lg mb-2">{weekday}</h3>
                                {children.map(child => (
                                    <div key={child.id} className="flex items-center mb-2">
                                        <span className="w-1/3">{child.name}:</span>
                                        <input
                                            type="time"
                                            value={editPickupTimes[weekday]?.[child.name] || ''}
                                            onChange={(e) => handlePickupTimeChange(weekday, child.name, e.target.value)}
                                            className="w-1/3 p-1 border rounded"
                                        />
                                    </div>
                                ))}
                                <button onClick={() => updatePickupTimes(weekday, editPickupTimes[weekday])} className={`${buttonClass} mt-2`}>Speichern für {weekday}</button>
                            </div>
                        ))}
                    </div>

                    <div className={cardClass}>
                        <h2 className="text-xl font-semibold mb-4">Einmalige Abholzeiten verwalten</h2>
                        <div className="flex items-center mb-2">
                            <label className="w-1/3">Datum:</label>
                            <input 
                                type="date"
                                value={editOneTimePickupTimes.date}
                                onChange={(e) => setEditOneTimePickupTimes({...editOneTimePickupTimes, date: e.target.value})}
                                className="w-1/3 p-1 border rounded"
                            />
                        </div>
                        {editOneTimePickupTimes.date && children.map(child => (
                            <div key={child.id} className="flex items-center mb-2">
                                <span className="w-1/3">{child.name}:</span>
                                <input
                                    type="time"
                                    value={editOneTimePickupTimes.times[child.name] || ''}
                                    onChange={(e) => handleOneTimePickupTimeChange(child.name, e.target.value)}
                                    className="w-1/3 p-1 border rounded"
                                />
                            </div>
                        ))}
                        <button onClick={updateOneTimePickupTimes} className={`${buttonClass} mt-2`}>Einmalige Zeit speichern</button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
