<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Abmeldung</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React + Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <link rel="icon" href="data:,">
  <style>html,body,#root{height:100%}</style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div id="root" class="h-full"></div>

  <script type="text/babel">
    const { useEffect, useState } = React;
    const WEEKDAYS = ["Sonntag","Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag"];

    // Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAYf7wZxI7szM2jdpelENIvVrDHE25M0Jc",
      authDomain: "neuabholung.firebaseapp.com",
      databaseURL: "https://neuabholung-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "neuabholung",
      storageBucket: "neuabholung.firebasestorage.app",
      messagingSenderId: "982992894873",
      appId: "1:982992894873:web:750e72ee79f585c1717108"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Helpers
    const qs = new URLSearchParams(location.search);
    const userId = qs.get('u');
    const name = qs.get('name');
    const cid = qs.get('cid');

    function todayKey(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }

    async function resetIfNewDay(u){
      if(!u) return;
      const metaRef = db.doc(`users/${u}/meta/dailyReset`);
      const snap = await metaRef.get();
      const last = snap.exists ? snap.data().lastReset : null;
      const today = todayKey();
      if (last === today) return;

      const kidsSnap = await db.collection(`users/${u}/children`).get();
      const batch = db.batch();
      kidsSnap.forEach(docSnap => {
        batch.update(docSnap.ref, { status:'anwesend', abgemeldetAm: null });
      });
      batch.set(metaRef, { lastReset: today }, { merge: true });
      await batch.commit();
    }

    function App(){
      const [msg,setMsg] = useState('Bitte warten…');

      useEffect(()=>{
        (async ()=>{
          if(!userId || !name || !cid){ setMsg('Ungültiger Link.'); return; }
          try{
            // Erst täglicher Reset, dann Abmeldelogik
            await resetIfNewDay(userId);

            const now = new Date();
            const todayIso = now.toISOString().slice(0,10);
            const weekday = WEEKDAYS[now.getDay()];

            // Einmalige Zeit?
            let timeStr = null;
            const oneDoc = await db.doc(`users/${userId}/oneTimePickupTimes/${todayIso}`).get();
            if(oneDoc.exists){
              const t = oneDoc.data().times || {};
              timeStr = t[name] || null;
            }
            // Regulär, falls keine einmalige
            if(!timeStr){
              const weekDoc = await db.doc(`users/${userId}/pickupTimes/${weekday}`).get();
              if(weekDoc.exists){
                const t = weekDoc.data().times || {};
                timeStr = t[name] || null;
              }
            }

            if(!timeStr){ setMsg(`Keine Abholzeit für ${name} hinterlegt.`); return; }

            // Zeit heute HH:mm
            const [hh,mm] = timeStr.split(':').map(v=>parseInt(v,10));
            const sched = new Date(); sched.setHours(hh, mm, 0, 0);

            const diffMs = sched.getTime() - now.getTime();
            const twoMinMs = 2*60*1000;

            if (diffMs > twoMinMs){
              const mins = Math.ceil((diffMs - twoMinMs)/60000);
              setMsg(`${name}, bitte warte noch ${mins} Minute(n), um dich abzumelden.`);
              return;
            }

            await db.doc(`users/${userId}/children/${cid}`).update({
              status:'abgemeldet',
              abgemeldetAm: new Date().toISOString()
            });

            setMsg(`${name} erfolgreich abgemeldet.`);
          }catch(e){
            console.error(e);
            setMsg('Fehler bei der Abmeldung.');
          }
        })();
      },[]);

      return (
        <div className="h-full grid place-items-center">
          <div className="bg-white rounded-xl shadow p-6 text-center max-w-md">
            <div className="text-lg">{msg}</div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
