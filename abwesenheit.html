<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Abwesenheit – Monat</title>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<style>
  :root{--bg:#0b1220;--card:#111827;--fg:#e5e7eb;--muted:#9aa4b2;--accent:#4299e1}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Arial,sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  header{display:flex;justify-content:space-between;align-items:center;margin:8px 0 16px}
  h1{margin:0;font-size:20px}
  .nav{display:flex;gap:8px;align-items:center}
  button{background:var(--accent);border:0;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .month{min-width:180px;text-align:center;font-weight:700}
  .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .dow{color:var(--muted);text-align:center;font-size:12px;padding:6px 0}
  .cell{background:var(--card);border-radius:12px;min-height:110px;padding:8px;display:flex;flex-direction:column}
  .cell .day{font-size:12px;color:var(--muted)}
  .names{margin-top:6px;font-size:12px;line-height:1.25;white-space:pre-wrap}
  .disabled{opacity:.35}
  .legend{margin:10px 0;color:var(--muted);font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Abwesenheit</h1>
    <div class="nav">
      <button id="prevBtn">« Monat zurück</button>
      <div id="monthTitle" class="month"></div>
      <button id="nextBtn">Monat vor »</button>
    </div>
  </header>

  <div class="legend">
    Namen = Kinder, die an diesem Tag in der Mäusegruppe abwesend waren
  </div>

  <div id="gridHeader" class="grid"></div>
  <div id="grid" class="grid"></div>
</div>

<script>
  // Firebase
  const firebaseConfig = {
    apiKey:"AIzaSyA9TnOd0oTD0tTNEqMi_7PHU-p0av-XjM0",
    databaseURL:"https://abab-58a5f-default-rtdb.europe-west1.firebasedatabase.app"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Konstanten
  const DAYS=["Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag","Sonntag"];
  const SCHOOL=new Set(["Montag","Dienstag","Mittwoch","Donnerstag","Freitag"]);
  const MIN_DATE="2025-08-27"; // ab diesem Datum zählen

  // TZ-Helper Europe/Berlin
  const tzOpts={timeZone:'Europe/Berlin'};
  const fmtMonth=new Intl.DateTimeFormat('de-DE',{...tzOpts,month:'long',year:'numeric'});
  function dTZ(d){ return new Date(new Date(d).toLocaleString('de-DE',tzOpts)); }
  function isoDate(d){ const x=dTZ(d); const y=x.getFullYear(), m=String(x.getMonth()+1).padStart(2,'0'), da=String(x.getDate()).padStart(2,'0'); return `${y}-${m}-${da}`; }
  function dowIndexMonFirst(d){ const js=dTZ(d).getDay(); return (js+6)%7; } // 0=Mo..6=So

  // DOM
  const monthTitle=document.getElementById('monthTitle');
  const grid=document.getElementById('grid');
  const gridHeader=document.getElementById('gridHeader');
  document.getElementById('prevBtn').onclick=()=>shiftMonth(-1);
  document.getElementById('nextBtn').onclick=()=>shiftMonth(1);

  // Kopfzeile
  (function renderDowHeader(){
    gridHeader.innerHTML='';
    ["Mo","Di","Mi","Do","Fr","Sa","So"].forEach(s=>{
      const el=document.createElement('div'); el.className='dow'; el.textContent=s; gridHeader.appendChild(el);
    });
  })();

  // Roster-Cache (Basisplan; leere Zeiten ignorieren)
  let ROSTER={};
  async function loadRoster(){
    const out={};
    for(const day of ["Montag","Dienstag","Mittwoch","Donnerstag","Freitag"]){
      const v=(await db.ref(day).once('value')).val()||{};
      out[day]=new Set(Object.entries(v).filter(([_,t])=>String(t).trim()!=="").map(([n])=>n));
    }
    ROSTER=out;
  }

  // Monats-State als Jahr/Monat, um TZ-Bugs zu vermeiden
  const today=dTZ(new Date());
  let curYear=today.getFullYear();
  let curMonth=today.getMonth()+1; // 1-12

  function shiftMonth(delta){
    let m=curMonth+delta, y=curYear;
    while(m<1){ m+=12; y--; }
    while(m>12){ m-=12; y++; }
    curMonth=m; curYear=y;
    renderMonth();
  }

  async function renderMonth(){
    if(!Object.keys(ROSTER).length) await loadRoster();

    const first=dTZ(new Date(curYear, curMonth-1, 1));
    const title=fmtMonth.format(first);
    monthTitle.textContent = title.charAt(0).toUpperCase()+title.slice(1);

    grid.innerHTML='';
    const lead=dowIndexMonFirst(first);
    const daysInMonth=new Date(curYear, curMonth, 0).getDate();

    // Leere Startfelder
    for(let i=0;i<lead;i++){ const c=document.createElement('div'); c.className='cell disabled'; grid.appendChild(c); }

    // Tage rendern
    for(let d=1; d<=daysInMonth; d++){
      const dateObj=dTZ(new Date(curYear, curMonth-1, d));
      const key=isoDate(dateObj);
      const idx=dowIndexMonFirst(dateObj); // 0..6
      const dayName=DAYS[idx];

      const cell=document.createElement('div'); cell.className='cell';
      const dayLabel=document.createElement('div'); dayLabel.className='day'; dayLabel.textContent=String(d);
      const namesDiv=document.createElement('div'); namesDiv.className='names';
      cell.appendChild(dayLabel); cell.appendChild(namesDiv); grid.appendChild(cell);

      if (!SCHOOL.has(dayName) || key < MIN_DATE){ namesDiv.textContent=''; continue; }

      const roster=Array.from(ROSTER[dayName]||[]);
      if(!roster.length){ namesDiv.textContent=''; continue; }

      try{
        const snap=await db.ref(`abmeldungen/${key}`).once('value');
        const checked=new Set(Object.keys(snap.val()||{}));
        const absent=roster.filter(n=>!checked.has(n));
        namesDiv.textContent=absent.join('\n');
      }catch{ namesDiv.textContent=''; }
    }

    // Tail auffüllen
    const total=lead+daysInMonth;
    const tail=(7-(total%7))%7;
    for(let i=0;i<tail;i++){ const c=document.createElement('div'); c.className='cell disabled'; grid.appendChild(c); }
  }

  document.addEventListener('DOMContentLoaded', renderMonth);
</script>
</body>
</html>