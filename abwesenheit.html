<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Abwesenheit – Monat</title>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<style>
  :root{--bg:#0b1220;--card:#111827;--fg:#e5e7eb;--muted:#9aa4b2;--accent:#4299e1}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Arial,sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  header{display:flex;justify-content:space-between;align-items:center;margin:8px 0 16px}
  h1{margin:0;font-size:22px}
  .nav{display:flex;gap:8px;align-items:center}
  button{background:var(--accent);border:0;color:#fff;border-radius:12px;padding:10px 14px;cursor:pointer}
  .month{min-width:200px;text-align:center;font-weight:700}
  .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .dow{color:var(--muted);text-align:center;font-size:12px;padding:6px 0}
  .cell{background:var(--card);border-radius:14px;min-height:110px;padding:8px;display:flex;flex-direction:column}
  .day{font-size:12px;color:var(--muted)}
  .day.muted{opacity:.55}
  .names{margin-top:6px;font-size:12px;line-height:1.25;white-space:pre-wrap}
  .legend{margin:10px 0;color:var(--muted);font-size:12px}
  #status{margin-top:8px;color:var(--muted);font-size:12px;text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Abwesenheit</h1>
    <div class="nav">
      <button id="prevBtn">« Monat zurück</button>
      <div id="monthTitle" class="month"></div>
      <button id="nextBtn">Monat vor »</button>
    </div>
  </header>

  <div class="legend">
    Namen = Kinder, die an diesem Tag in der Mäusegruppe abwesend waren
  </div>

  <div id="gridHeader" class="grid"></div>
  <div id="grid" class="grid"></div>
  <div id="status"></div>
</div>

<script>
  // Firebase
  const firebaseConfig = {
    apiKey:"AIzaSyA9TnOd0oTD0tTNEqMi_7PHU-p0av-XjM0",
    databaseURL:"https://abab-58a5f-default-rtdb.europe-west1.firebasedatabase.app"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Konstanten
  const SCHOOL = new Set(["Montag","Dienstag","Mittwoch","Donnerstag","Freitag"]);
  const MIN_DATE = "2025-08-27"; // ab diesem Datum zählen
  const DOW_SHORT = ["Mo","Di","Mi","Do","Fr","Sa","So"];
  const DOW_NAME  = ["Sonntag","Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag"];

  // Helper
  const pad2 = n => String(n).padStart(2,"0");
  const monthLabel = (y,m1) =>
    new Intl.DateTimeFormat("de-DE",{month:"long",year:"numeric"}).format(new Date(y,m1-1,1)).replace(/^./,c=>c.toUpperCase());
  const mondayOffset = (y,m1) => ((new Date(y,m1-1,1).getDay()+6)%7); // 0=Mo..6=So
  const daysInMonth  = (y,m1) => new Date(y,m1,0).getDate();          // m1=1..12

  // DOM
  const titleEl = document.getElementById("monthTitle");
  const grid    = document.getElementById("grid");
  const gridHdr = document.getElementById("gridHeader");
  const statusEl= document.getElementById("status");
  document.getElementById("prevBtn").onclick = () => shiftMonth(-1);
  document.getElementById("nextBtn").onclick = () => shiftMonth(1);

  // Header Mo–So
  (function renderHeader(){
    gridHdr.innerHTML="";
    DOW_SHORT.forEach(s=>{
      const el=document.createElement("div");
      el.className="dow";
      el.textContent=s;
      gridHdr.appendChild(el);
    });
  })();

  // Roster cache
  let ROSTER={}; // { Montag:Set(names), ... }
  async function loadRoster(){
    const out={};
    for(const day of ["Montag","Dienstag","Mittwoch","Donnerstag","Freitag"]){
      const v=(await db.ref(day).once("value")).val()||{};
      out[day]=new Set(Object.entries(v).filter(([_,t])=>String(t).trim()!=="").map(([n])=>n));
    }
    ROSTER=out;
  }

  // Monats-State: aktueller Monat beim Start
  const now = new Date();
  let curY = now.getFullYear();
  let curM = now.getMonth()+1; // 1..12

  function shiftMonth(delta){
    curM += delta;
    while(curM<1){ curM+=12; curY--; }
    while(curM>12){ curM-=12; curY++; }
    renderMonth();
  }

  async function renderMonth(){
    statusEl.textContent="Lade…";
    if(!Object.keys(ROSTER).length) await loadRoster();

    titleEl.textContent = monthLabel(curY,curM);

    const lead = mondayOffset(curY,curM);
    const dim  = daysInMonth(curY,curM);

    grid.innerHTML="";
    // 6×7 Zellen
    for(let i=0;i<42;i++){
      // Mapping i -> y,m,d
      let dnum = i - lead + 1;
      let y = curY, m = curM, d;

      if(dnum < 1){
        // vorheriger Monat
        let pm = m-1, py=y;
        if(pm<1){ pm=12; py--; }
        const pdim = daysInMonth(py,pm);
        d = pdim + dnum;
        y = py; m = pm;
      } else if(dnum > dim){
        // nächster Monat
        let nm = m+1, ny=y;
        if(nm>12){ nm=1; ny++; }
        d = dnum - dim;
        y = ny; m = nm;
      } else {
        d = dnum; // im aktuellen Monat
      }

      const key = `${y}-${pad2(m)}-${pad2(d)}`;
      const jsDow = new Date(y, m-1, d).getDay(); // 0=So..6=Sa
      const dowName = DOW_NAME[jsDow];
      const inCurrent = (m===curM);

      // Zelle
      const cell=document.createElement("div");
      cell.className="cell";
      const dayLbl=document.createElement("div");
      dayLbl.className = "day" + (inCurrent ? "" : " muted");
      dayLbl.textContent = String(d);
      const namesDiv=document.createElement("div");
      namesDiv.className="names";
      cell.appendChild(dayLbl);
      cell.appendChild(namesDiv);
      grid.appendChild(cell);

      // Nur Werktage und ab Mindestdatum
      if(!SCHOOL.has(dowName) || key < MIN_DATE) continue;

      // Erwartete Kinder
      const roster = Array.from(ROSTER[dowName]||[]);
      if(!roster.length) continue;

      try{
        const snap = await db.ref(`abmeldungen/${key}`).once("value");
        const checked = new Set(Object.keys(snap.val()||{}));
        const absent  = roster.filter(n=>!checked.has(n));
        namesDiv.textContent = absent.join("\n");
      }catch{
        namesDiv.textContent = "";
      }
    }

    statusEl.textContent="Fertig.";
  }

  document.addEventListener("DOMContentLoaded", renderMonth);
</script>
</body>
</html>