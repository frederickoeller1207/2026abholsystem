<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Abwesenheit – Monat</title>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<style>
  :root{--bg:#0b1220;--card:#111827;--fg:#e5e7eb;--muted:#9aa4b2;--accent:#4299e1}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Arial,sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  header{display:flex;justify-content:space-between;align-items:center;margin:8px 0 16px}
  h1{margin:0;font-size:22px}
  .nav{display:flex;gap:8px;align-items:center}
  button{background:var(--accent);border:0;color:#fff;border-radius:12px;padding:10px 14px;cursor:pointer}
  .month{min-width:200px;text-align:center;font-weight:700}
  .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .dow{color:var(--muted);text-align:center;font-size:12px;padding:6px 0}
  .cell{background:var(--card);border-radius:14px;min-height:110px;padding:8px;display:flex;flex-direction:column}
  .day{font-size:12px;color:var(--muted)}
  .day.muted{opacity:.6}
  .names{margin-top:6px;font-size:12px;line-height:1.25;white-space:pre-wrap}
  .legend{margin:10px 0;color:var(--muted);font-size:12px}
  #status{margin-top:8px;color:var(--muted);font-size:12px;text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Abwesenheit</h1>
    <div class="nav">
      <button id="prevBtn">« Monat zurück</button>
      <div id="monthTitle" class="month"></div>
      <button id="nextBtn">Monat vor »</button>
    </div>
  </header>

  <div class="legend">
    Namen = Kinder, die an diesem Tag in der Mäusegruppe abwesend waren
  </div>

  <div id="gridHeader" class="grid"></div>
  <div id="grid" class="grid"></div>
  <div id="status"></div>
</div>

<script>
  // Firebase
  const firebaseConfig = {
    apiKey:"AIzaSyA9TnOd0oTD0tTNEqMi_7PHU-p0av-XjM0",
    databaseURL:"https://abab-58a5f-default-rtdb.europe-west1.firebasedatabase.app"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Konstanten
  const SCHOOL = new Set(["Montag","Dienstag","Mittwoch","Donnerstag","Freitag"]);
  const MIN_DATE = "2025-08-27"; // ab diesem Datum zählen

  // TZ-Helper Europe/Berlin
  const tz = { timeZone:"Europe/Berlin" };
  function dTZ(d){ return new Date(new Date(d).toLocaleString("de-DE", tz)); }
  function isoDate(d){ const x=dTZ(d); const y=x.getFullYear(), m=String(x.getMonth()+1).padStart(2,"0"), da=String(x.getDate()).padStart(2,"0"); return `${y}-${m}-${da}`; }
  function monthLabel(d){ return dTZ(d).toLocaleDateString("de-DE", { ...tz, month:"long", year:"numeric" }); }
  function dowMonFirst(d){ const js=dTZ(d).getDay(); return (js+6)%7; } // 0=Mo … 6=So
  function addDays(d,n){ const x=dTZ(d); x.setDate(x.getDate()+n); return x; }
  const DOW_SHORT = ["Mo","Di","Mi","Do","Fr","Sa","So"];
  const DOW_NAME  = ["Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag","Sonntag"];

  // DOM
  const monthTitle = document.getElementById("monthTitle");
  const gridHeader = document.getElementById("gridHeader");
  const grid       = document.getElementById("grid");
  const statusEl   = document.getElementById("status");
  document.getElementById("prevBtn").onclick = ()=>shiftMonth(-1);
  document.getElementById("nextBtn").onclick = ()=>shiftMonth(1);

  // Kopfzeile (Mo–So)
  (function renderDowHeader(){
    gridHeader.innerHTML = "";
    DOW_SHORT.forEach(s=>{
      const el=document.createElement("div");
      el.className="dow";
      el.textContent=s;
      gridHeader.appendChild(el);
    });
  })();

  // Roster-Cache (Basisplan; leere Zeiten ignorieren)
  let ROSTER = {}; // { Montag:Set(names), ... }
  async function loadRoster(){
    const out = {};
    for (const day of ["Montag","Dienstag","Mittwoch","Donnerstag","Freitag"]){
      const v = (await db.ref(day).once("value")).val() || {};
      out[day] = new Set(
        Object.entries(v)
          .filter(([_,t]) => String(t).trim() !== "")
          .map(([n]) => n)
      );
    }
    ROSTER = out;
  }

  // Monats-State
  let cur = dTZ(new Date());            // heute
  cur.setDate(1);                       // auf den 1. des Monats

  function shiftMonth(delta){
    cur = dTZ(new Date(cur.getFullYear(), cur.getMonth() + delta, 1));
    renderMonth();
  }

  async function renderMonth(){
    statusEl.textContent = "Lade…";
    if (!Object.keys(ROSTER).length) await loadRoster();

    monthTitle.textContent = capitalize(monthLabel(cur));

    // 6 × 7 Raster
    grid.innerHTML = "";
    const lead = dowMonFirst(cur);                           // Anzahl Felder vor dem 1.
    const daysInMonth = new Date(cur.getFullYear(), cur.getMonth()+1, 0).getDate();
    const firstCellDate = addDays(cur, -lead);

    // Vorab alle Abmeldungen des Monats abrufen (eine Anfrage pro Tag ist auch ok; hier simpel pro Tag)
    const absentCache = {};

    // Zellen bauen
    for (let i=0; i<42; i++){
      const dayDate = addDays(firstCellDate, i);
      const key = isoDate(dayDate);
      const inMonth = (dayDate.getMonth() === cur.getMonth());
      const idx = dowMonFirst(dayDate);                 // 0..6
      const dayName = DOW_NAME[idx];

      const cell = document.createElement("div");
      cell.className = "cell";

      const dayLabel = document.createElement("div");
      dayLabel.className = "day" + (inMonth ? "" : " muted");
      dayLabel.textContent = String(dayDate.getDate());
      cell.appendChild(dayLabel);

      const namesDiv = document.createElement("div");
      namesDiv.className = "names";
      cell.appendChild(namesDiv);

      grid.appendChild(cell);

      // Nur Werktage im aktuellen/anderen Monat anzeigen; vor MIN_DATE keine Namen
      if (!SCHOOL.has(dayName) || key < MIN_DATE) continue;

      // Erwartete Kinder
      const roster = Array.from(ROSTER[dayName] || []);
      if (!roster.length) continue;

      // Abmeldungen laden und Abwesende eintragen
      try{
        if (!(key in absentCache)){
          const snap = await db.ref(`abmeldungen/${key}`).once("value");
          const checked = new Set(Object.keys(snap.val() || {}));
          const absent  = roster.filter(n => !checked.has(n));
          absentCache[key] = absent;
        }
        namesDiv.textContent = absentCache[key].join("\n");
      }catch(e){
        namesDiv.textContent = "";
      }
    }
    statusEl.textContent = "Fertig.";
  }

  function capitalize(s){ return s ? s.charAt(0).toUpperCase()+s.slice(1) : s; }

  document.addEventListener("DOMContentLoaded", renderMonth);
</script>
</body>
</html>