<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Abholzeiten – Übersicht</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React + Babel (für JSX ohne Build) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase (Compat, kein Auth nötig) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- Optional: date-fns nur falls du später brauchst -->
  <link rel="icon" href="data:,">
  <style>html,body,#root{height:100%}</style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div id="root" class="h-full"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useState } = React;
    const WEEKDAYS = ["Sonntag","Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag"];

    // --- Firebase Init ---
    const firebaseConfig = {
      apiKey: "AIzaSyAYf7wZxI7szM2jdpelENIvVrDHE25M0Jc",
      authDomain: "neuabholung.firebaseapp.com",
      databaseURL: "https://neuabholung-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "neuabholung",
      storageBucket: "neuabholung.firebasestorage.app",
      messagingSenderId: "982992894873",
      appId: "1:982992894873:web:750e72ee79f585c1717108"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- Helpers ---
    const qs = new URLSearchParams(location.search);
    const userId = qs.get('u') || 'public';

    function todayKey(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }

    async function resetIfNewDay(u){
      if(!u) return;
      const metaRef = db.doc(`users/${u}/meta/dailyReset`);
      const snap = await metaRef.get();
      const last = snap.exists ? snap.data().lastReset : null;
      const today = todayKey();
      if (last === today) return;

      const kidsSnap = await db.collection(`users/${u}/children`).get();
      const batch = db.batch();
      kidsSnap.forEach(docSnap => {
        batch.update(docSnap.ref, { status:'anwesend', abgemeldetAm: null });
      });
      batch.set(metaRef, { lastReset: today }, { merge: true });
      await batch.commit();
    }

    function groupByTime(sortedEntries){
      const out = {};
      for(const [name,time] of sortedEntries){
        const key = time || "—";
        (out[key] ||= []).push(name);
      }
      return out;
    }

    function App(){
      const [dateStr, setDateStr] = useState(() => new Date().toISOString().slice(0,10));
      const [children, setChildren] = useState([]);
      const [weeklyTimes, setWeeklyTimes] = useState({});
      const [oneTimes, setOneTimes] = useState(null);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState("");

      async function loadAll(sel){
        setLoading(true); setError("");
        try{
          await resetIfNewDay(userId);

          const kids = await db.collection(`users/${userId}/children`).get();
          setChildren(kids.docs.map(d => ({ id:d.id, ...d.data() })));

          const d = new Date(sel);
          const weekday = WEEKDAYS[d.getDay()];
          const weekDoc = await db.doc(`users/${userId}/pickupTimes/${weekday}`).get();
          setWeeklyTimes(weekDoc.exists ? (weekDoc.data().times || {}) : {});

          const oneDoc = await db.doc(`users/${userId}/oneTimePickupTimes/${sel}`).get();
          setOneTimes(oneDoc.exists ? (oneDoc.data().times || {}) : null);
        }catch(e){
          console.error(e);
          setError(e.message || String(e));
        }finally{
          setLoading(false);
        }
      }

      useEffect(()=>{ loadAll(dateStr); },[dateStr]);

      const effectiveTimes = useMemo(()=> oneTimes || weeklyTimes || {}, [oneTimes, weeklyTimes]);

      const entries = useMemo(()=>{
        const arr = children.map(k => [k.name, effectiveTimes[k.name] || null]);
        arr.sort((a,b)=>{
          if(!a[1] && !b[1]) return a[0].localeCompare(b[0], 'de');
          if(!a[1]) return 1; if(!b[1]) return -1;
          return a[1].localeCompare(b[1]);
        });
        return arr;
      },[children, effectiveTimes]);

      const grouped = useMemo(()=> groupByTime(entries), [entries]);

      return (
        <div className="max-w-3xl mx-auto p-4 space-y-4">
          <header className="flex items-center justify-between">
            <h1 className="text-2xl font-bold">Abholzeiten</h1>
            <input type="date" value={dateStr} onChange={e=>setDateStr(e.target.value)} className="border rounded px-3 py-2"/>
          </header>

          {loading && <p className="text-sm text-slate-500">Lade…</p>}
          {error && <p className="text-sm text-red-600">{error}</p>}

          {!loading && Object.keys(grouped).length === 0 && (
            <p className="text-slate-600">Keine Daten für diesen Tag.</p>
          )}

          {!loading && Object.entries(grouped).map(([time, names])=>(
            <section key={time} className="bg-white rounded-xl shadow p-4 mb-3">
              <div className="text-center font-semibold text-lg">{time === "—" ? "Keine Zeit" : time}</div>
              <div className="mt-3 grid grid-cols-1 gap-1">
                {names.map(n=>{
                  const kid = children.find(k=>k.name===n);
                  const isAb = kid?.status === 'abgemeldet';
                  let when = '';
                  if (kid?.abgemeldetAm){
                    const d = new Date(kid.abgemeldetAm);
                    const hh = String(d.getHours()).padStart(2,'0');
                    const mm = String(d.getMinutes()).padStart(2,'0');
                    when = ` – ${hh}:${mm}`;
                  }
                  return (
                    <div key={n} className={"text-base " + (isAb ? "text-red-600 line-through" : "")}>
                      {n}{isAb ? when : ""}
                    </div>
                  )
                })}
              </div>
            </section>
          ))}

          <footer className="text-center text-xs text-slate-400 pt-6">
            Nutzer-ID „{userId}“ · Einmalige Zeiten überschreiben reguläre Zeiten · Täglicher Auto-Reset aktiv.
          </footer>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
