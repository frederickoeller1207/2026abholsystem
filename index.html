<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abholzeiten - Ansicht</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel" data-type="module">
        // Import der Firebase- und Hilfsbibliotheken
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signInAnonymously } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, addDoc, deleteDoc, getDocs, onSnapshot, query, where } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
        import { format, formatISO, parseISO, isBefore, isAfter, differenceInMinutes, startOfDay, getDay, addDays, subDays } from 'https://cdn.jsdelivr.net/npm/date-fns@2.28.0/esm/index.js';
        import { de } from 'https://cdn.jsdelivr.net/npm/date-fns@2.28.0/esm/locale/de/index.js';
        
        const { useState, useEffect, createElement } = React;
        const ReactDOM = ReactDOM.createRoot(document.getElementById('root'));
        
        // Globale Variablen
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : 'null');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        if (!firebaseConfig) {
            console.error("Firebase-Konfiguration nicht gefunden.");
        }
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Helper-Funktion für die Datenpfade
        const getDataPath = (collectionName, userId) => {
            return `/artifacts/${appId}/users/${userId}/${collectionName}`;
        };
        
        // Hilfsfunktion zur Formatierung des Wochentags auf Deutsch
        const formatDay = (date) => {
            const weekdays = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
            return weekdays[getDay(date)];
        };

        //----------------------------------------------------------------------------------------------------------------------
        //
        //  1. Ansichtsseite (PublicView)
        //
        //----------------------------------------------------------------------------------------------------------------------
        const PublicView = () => {
            const [userId, setUserId] = useState(null);
            const [children, setChildren] = useState([]);
            const [pickupTimes, setPickupTimes] = useState({});
            const [oneTimePickupTimes, setOneTimePickupTimes] = useState({});
            const [selectedDate, setSelectedDate] = useState(new Date());
            const [isLoading, setIsLoading] = useState(true);
            const [errorMessage, setErrorMessage] = useState('');
        
            useEffect(() => {
                const unsubscribeAuth = onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        setUserId(user.uid);
                    } else {
                        await signInAnonymously(auth);
                    }
                });
        
                return () => unsubscribeAuth();
            }, []);
        
            useEffect(() => {
                if (!userId) return;
        
                const cleanupFunctions = [];
                setIsLoading(true);
        
                const childrenPath = getDataPath('children', userId);
                const pickupTimesPath = getDataPath('pickupTimes', userId);
                const oneTimePickupTimesPath = getDataPath('oneTimePickupTimes', userId);
        
                const qChildren = query(collection(db, childrenPath));
                const unsubscribeChildren = onSnapshot(qChildren, (snapshot) => {
                    const childrenData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setChildren(childrenData);
                    setIsLoading(false);
                }, (error) => {
                    console.error("Fehler beim Laden der Kinderdaten:", error);
                    setErrorMessage("Fehler beim Laden der Kinderdaten.");
                    setIsLoading(false);
                });
                cleanupFunctions.push(unsubscribeChildren);
        
                const qPickupTimes = query(collection(db, pickupTimesPath));
                const unsubscribePickupTimes = onSnapshot(qPickupTimes, (snapshot) => {
                    const timesData = {};
                    snapshot.docs.forEach(doc => {
                        timesData[doc.id] = doc.data().times;
                    });
                    setPickupTimes(timesData);
                }, (error) => {
                    console.error("Fehler beim Laden der regulären Abholzeiten:", error);
                    setErrorMessage("Fehler beim Laden der regulären Abholzeiten.");
                });
                cleanupFunctions.push(unsubscribePickupTimes);
        
                const qOneTimePickupTimes = query(collection(db, oneTimePickupTimesPath));
                const unsubscribeOneTimePickupTimes = onSnapshot(qOneTimePickupTimes, (snapshot) => {
                    const oneTimeData = {};
                    snapshot.docs.forEach(doc => {
                        oneTimeData[doc.id] = doc.data().times;
                    });
                    setOneTimePickupTimes(oneTimeData);
                }, (error) => {
                    console.error("Fehler beim Laden der einmaligen Abholzeiten:", error);
                    setErrorMessage("Fehler beim Laden der einmaligen Abholzeiten.");
                });
                cleanupFunctions.push(unsubscribeOneTimePickupTimes);
        
                return () => cleanupFunctions.forEach(fn => fn());
            }, [userId]);
        
            // Funktion zum Abrufen der Abholzeiten für ein bestimmtes Datum
            const getTimesForDate = (date) => {
                const dateString = format(date, 'yyyy-MM-dd');
                const dayOfWeek = formatDay(date);
        
                const oneTime = oneTimePickupTimes[dateString];
                if (oneTime) {
                    return oneTime;
                }
        
                const regular = pickupTimes[dayOfWeek];
                return regular || {};
            };
        
            const currentDayTimes = getTimesForDate(selectedDate);
            const sortedChildren = [...children].sort((a, b) => {
                const timeA = currentDayTimes[a.name] || '23:59';
                const timeB = currentDayTimes[b.name] || '23:59';
                return timeA.localeCompare(timeB);
            });
        
            const handleDateChange = (event) => {
                setSelectedDate(new Date(event.target.value));
            };
            
            // UI-Komponente für die Ansichtsseite
            return (
                <div className="container mx-auto p-4 md:p-8 bg-white shadow-lg rounded-xl mt-8 max-w-2xl">
                    <h1 className="text-3xl font-bold mb-6 text-center text-indigo-800">Abholzeiten</h1>
                    {errorMessage && <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4" role="alert">{errorMessage}</div>}
                    
                    <div className="mb-6 text-center">
                        <input
                            type="date"
                            value={format(selectedDate, 'yyyy-MM-dd')}
                            onChange={handleDateChange}
                            className="p-3 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-200"
                        />
                    </div>
        
                    <h2 className="text-2xl font-semibold mb-4 text-center">
                        {format(selectedDate, 'd. MMMM yyyy', { locale: de })}
                    </h2>
        
                    {isLoading ? (
                        <div className="text-center text-gray-500">Lade Daten...</div>
                    ) : (
                        <div className="space-y-4">
                            {sortedChildren.length > 0 ? (
                                sortedChildren.map(child => {
                                    const pickupTime = currentDayTimes[child.name];
                                    const isAbsent = child.status === 'abgemeldet' && startOfDay(parseISO(child.abgemeldetAm)).getTime() === startOfDay(selectedDate).getTime();
        
                                    return (
                                        <div
                                            key={child.id}
                                            className={`p-4 rounded-lg shadow-sm transition-colors duration-200 ${isAbsent ? 'bg-red-100 text-red-700 line-through' : 'bg-gray-50'}`}
                                        >
                                            <div className="flex justify-between items-center">
                                                <span className="font-medium text-lg">
                                                    {child.name}
                                                </span>
                                                <span className="font-mono text-xl font-bold">
                                                    {pickupTime || '--:--'}
                                                </span>
                                            </div>
                                            {isAbsent && (
                                                <p className="text-sm mt-1">
                                                    Abgemeldet um: {format(parseISO(child.abgemeldetAm), 'HH:mm', { locale: de })}
                                                </p>
                                            )}
                                        </div>
                                    );
                                })
                            ) : (
                                <div className="text-center text-gray-500">
                                    Keine Kinder oder Abholzeiten gefunden.
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };
        
        // Rendert die PublicView-Komponente in das Root-Element
        const rootElement = document.getElementById('root');
        if (rootElement) {
            const root = ReactDOM.createRoot(rootElement);
            root.render(createElement(PublicView));
        }
    </script>
</body>
</html>
