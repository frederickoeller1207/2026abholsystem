<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Abholzeiten – Tagesansicht</title>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<style>
  body{font-family:system-ui,Segoe UI,Arial,sans-serif;margin:0;background:#f6f7f9}
  .wrap{max-width:720px;margin:0 auto;padding:16px}
  h1{margin:12px 0;text-align:center;font-size:22px}
  #info{margin:8px 0;text-align:center;color:#555}
  ul{list-style:none;padding:0;margin:12px 0}
  li{background:#fff;margin:8px 0;padding:14px 12px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 1px 3px rgba(0,0,0,.06)}
  .name{font-weight:600}
  .muted{color:#777}
  .strike{text-decoration:line-through;color:#999}
  .pill{padding:4px 8px;border-radius:999px;background:#eef;border:1px solid #dde;font-variant-numeric:tabular-nums}
  .row{display:flex;gap:8px;justify-content:center;margin-top:10px}
  button{padding:8px 12px;border:0;border-radius:8px;background:#2e7d32;color:#fff;cursor:pointer}
  button.secondary{background:#607d8b}
</style>
</head>
<body>
<div class="wrap">
  <h1 id="title">Tagesansicht</h1>
  <div id="info">Lade…</div>
  <ul id="list"></ul>
  <div class="row">
    <button id="refreshBtn" class="secondary">Aktualisieren</button>
  </div>
</div>

<script>
  // Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyA9TnOd0oTD0tTNEqMi_7PHU-p0av-XjM0",
    databaseURL: "https://abab-58a5f-default-rtdb.europe-west1.firebasedatabase.app"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Konstanten
  const WEEKDAYS = ["Sonntag","Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag"];
  const WORKDAYS = ["Montag","Dienstag","Mittwoch","Donnerstag","Freitag"];

  // DOM
  const titleEl = document.getElementById('title');
  const infoEl  = document.getElementById('info');
  const listEl  = document.getElementById('list');
  document.getElementById('refreshBtn').addEventListener('click', loadDay);

  // Helper: Datum/Zeiten in Europe/Berlin
  function nowBerlin() {
    return new Date(new Date().toLocaleString('de-DE', { timeZone: 'Europe/Berlin' }));
  }
  function todayKey() {
    const d = nowBerlin();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }
  function todayWeekdayName() {
    return WEEKDAYS[nowBerlin().getDay()];
  }
  function parseHHMM(s){
    // returns minutes since 00:00, or null
    if (!s || !/^\d{2}:\d{2}$/.test(s)) return null;
    const [h,m] = s.split(':').map(n=>parseInt(n,10));
    return h*60+m;
  }
  function minutesNow(){
    const d = nowBerlin();
    return d.getHours()*60 + d.getMinutes();
  }

  // URL-Parameter
  const params = new URLSearchParams(location.search);
  const paramChild = params.get('child');
  const isAdmin = params.get('admin') === '1';

  // Hauptlogik
  async function loadDay(){
    const dayName = todayWeekdayName();
    titleEl.textContent = `Heute: ${dayName}`;
    if (!WORKDAYS.includes(dayName)) {
      infoEl.textContent = "Kein OGS-Tag. Es werden nur Montag–Freitag geführt.";
      listEl.innerHTML = "";
      return;
    }

    infoEl.textContent = "Lade…";
    listEl.innerHTML = "";

    try{
      const [timesSnap, statusSnap] = await Promise.all([
        db.ref(dayName).once('value'),
        db.ref(`abmeldungen/${todayKey()}`).once('value')
      ]);

      const times = timesSnap.val() || {};
      const status = statusSnap.val() || {};

      // Optionaler Auto-Abmeldeversuch per Link
      if (paramChild){
        await tryCheckoutLink(dayName, times, status);
      }

      // Daten erneut lesen, falls Status geändert wurde
      const status2 = (await db.ref(`abmeldungen/${todayKey()}`).once('value')).val() || {};

      // Sortierung nach Uhrzeit
      const entries = Object.entries(times)
        .map(([name, t]) => ({name, timeStr: t, mins: parseHHMM(String(t)) }))
        .sort((a,b)=>{
          if (a.mins===null && b.mins===null) return a.name.localeCompare(b.name,'de');
          if (a.mins===null) return 1;
          if (b.mins===null) return -1;
          return a.mins - b.mins;
        });

      if (entries.length === 0){
        infoEl.textContent = "Keine Einträge für heute.";
        return;
      }

      entries.forEach(e=>{
        const li = document.createElement('li');
        const left = document.createElement('div');
        left.innerHTML = `<span class="name">${e.name}</span><br><span class="muted">Abholzeit</span>`;
        const right = document.createElement('div');
        right.innerHTML = `<span class="pill">${e.timeStr || "–"}</span>`;
        li.appendChild(left); li.appendChild(right);
        if (status2 && status2[e.name] === true){
          li.classList.add('strike');
        }
        listEl.appendChild(li);
      });
      infoEl.textContent = "Fertig.";
    }catch(err){
      console.error(err);
      infoEl.textContent = "Fehler beim Laden. Prüfe Regeln/Verbindung.";
    }
  }

  async function tryCheckoutLink(dayName, times, status){
    const name = paramChild;
    const stored = String(times?.[name] || "");
    if (!stored){
      infoEl.textContent = `Unbekanntes Kind: ${name}`;
      return;
    }
    // Wenn bereits abgemeldet: nichts tun
    const statusRef = db.ref(`abmeldungen/${todayKey()}/${name}`);
    const already = status && status[name] === true;
    if (already){
      infoEl.textContent = `${name}: bereits abgemeldet.`;
      return;
    }

    // Zeitfenster prüfen
    const target = parseHHMM(stored);
    const nowM = minutesNow();
    const allowedAt = target !== null ? target - 5 : null;

    if (isAdmin || allowedAt === null || nowM >= allowedAt){
      try{
        await statusRef.set(true);
        infoEl.textContent = `${name}: erfolgreich abgemeldet.`;
      }catch(e){
        console.error(e);
        infoEl.textContent = `${name}: Abmeldung fehlgeschlagen.`;
      }
    }else{
      const wait = Math.max(0, allowedAt - nowM);
      infoEl.textContent = `${name}: bitte noch ${wait} Min warten.`;
    }
  }

  // Start
  document.addEventListener('DOMContentLoaded', loadDay);
</script>
</body>
</html>