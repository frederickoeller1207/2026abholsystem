<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Abholsystem – Tagesansicht</title>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<style>
  :root{--fg:#1a202c;--muted:#64748b;--accent:#4299e1;--bg:#f0f4f8;--white:#fff}
  body{font-family:system-ui,Segoe UI,Arial,sans-serif;margin:0;background:var(--bg);color:var(--fg)}
  .wrap{max-width:780px;margin:0 auto;padding:16px}
  h1{margin:10px 0;text-align:center;font-size:22px}
  .row{display:flex;gap:8px;justify-content:center;margin:8px 0}
  button{padding:9px 14px;border:0;border-radius:999px;background:var(--accent);color:#fff;cursor:pointer}
  button.secondary{background:#64748b}
  #info{text-align:center;margin:6px 0;color:#475569}
  .slot{background:var(--white);border-radius:10px;padding:10px 12px;margin:10px 0;box-shadow:0 1px 3px rgba(0,0,0,.06)}
  .slot h2{margin:0 0 8px 0;font-size:16px}
  .names{list-style:none;margin:0;padding:0}
  .names li{padding:4px 0;font-size:16px;line-height:1.35}
  .strike{text-decoration:line-through;color:#e53e3e}
  .onetime{color:#f6e05e}
  .modal{display:none;position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,.4);justify-content:center;align-items:center}
  .box{background:#fff;padding:16px;border-radius:10px;width:min(92vw,520px)}
  .days{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:8px}
  .days button{background:#e2e8f0;color:#334155}
  .days button.active{background:#38a169;color:#fff}
  #link-view{display:none;min-height:50vh;display:flex;align-items:center;justify-content:center;}
  /* NEU: Hintergrundfarbe für Sperr-Nachricht */
  #link-msg{background:#fff;padding:22px 26px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08);font-size:20px;text-align:center;}
  #link-msg.locked { background-color: #fcebeb; border: 2px solid #e53e3e; } 
</style>
</head>
<body>
<div class="wrap">
  <h1 id="title">Tagesansicht</h1>

  <div id="controls" class="row" style="display:none">
    <button id="chooseDayBtn" class="secondary">Wochentag wählen</button>
    <button id="manualBtn" class="secondary">Manuell abmelden</button>
    <button id="adminLinkBtn">Abholzeit anpassen</button>
  </div>

  <div id="info">Lade…</div>
  <div id="slots"></div>
  <div id="link-view"><div id="link-msg"></div></div>
</div>

<div id="dayModal" class="modal"><div class="box">
  <h3>Wochentag auswählen</h3>
  <div id="dayBtns" class="days"></div>
  <div class="row" style="margin-top:10px"><button id="closeDay" class="secondary">Schließen</button></div>
</div></div>

<script>
  /* === Abholsystem-DB (Zeiten & Abmeldungen) === */
  const appAbhol = firebase.initializeApp({
    apiKey:"AIzaSyA9TnOd0oTD0tTNEqMi_7PHU-p0av-XjM0",
    databaseURL:"https://abab-58a5f-default-rtdb.europe-west1.firebasedatabase.app"
  }, "abhol");
  const dbAbhol = firebase.app("abhol").database();

  /* === Systemmodus & Globale Sperre (Gesamt-DB) === */
  const appMode = firebase.initializeApp({
    apiKey:"AIzaSyAQaNKUa-RKvUcwlPpWnEyKxcVjYV6cZuU",
    databaseURL:"https://gesamt-dae4e-default-rtdb.europe-west1.firebasedatabase.app"
  }, "mode");
  const dbGesamt = firebase.app("mode").database();

  /* === Utils === */
  function berlinParts(d=new Date()){
    const fmt = new Intl.DateTimeFormat('de-DE',{timeZone:'Europe/Berlin',hour12:false,
      year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',weekday:'long'});
    const parts = fmt.formatToParts(d); const get=t=>parts.find(p=>p.type===t)?.value;
    return {y:Number(get('year')), m:get('month'), d:get('day'),
            h:Number(get('hour')), min:Number(get('minute')), weekday:get('weekday')};
  }
  function dateKey(){ const p=berlinParts(); return `${p.y}-${p.m}-${p.d}`; }
  function todayName(){ const w=berlinParts().weekday; return w.charAt(0).toUpperCase()+w.slice(1); }
  function nowMinutes(){ const p=berlinParts(); return p.h*60+p.min; }
  function parseHHMM(s){ if(!s||!/^\d{2}:\d{2}$/.test(s)) return null; const [h,m]=s.split(':').map(Number); return h*60+m; }

  const SCHOOL=["Montag","Dienstag","Mittwoch","Donnerstag","Freitag"];
  const qs = s=>document.querySelector(s);

  let currentDay=todayName();
  const params=new URLSearchParams(location.search);
  const linkChild=params.get('child');
  const isAdmin=params.get('admin')==='1';

  const titleEl=qs('#title'), infoEl=qs('#info'), slotsEl=qs('#slots');
  const controls = document.getElementById('controls');
  const linkMsgEl = document.getElementById('link-msg');

  qs('#chooseDayBtn').onclick=()=>openDayModal();
  qs('#closeDay').onclick=()=>qs('#dayModal').style.display='none';
  qs('#manualBtn').onclick=()=>{ location.href='manuell.html'; };
  qs('#adminLinkBtn').onclick=()=>{ location.href='admin.html'; };

  function openDayModal(){
    const c=qs('#dayBtns'); c.innerHTML='';
    SCHOOL.forEach(d=>{
      const b=document.createElement('button');
      b.textContent=d;
      if(d===currentDay) b.classList.add('active');
      b.onclick=()=>{ currentDay=d; qs('#dayModal').style.display='none'; loadDay(); };
      c.appendChild(b);
    });
    qs('#dayModal').style.display='flex';
  }

  function enterLinkMode(msg, isLocked=false){
    linkMsgEl.innerHTML=msg; // Verwende innerHTML für `<br>` und Formatierung
    linkMsgEl.classList.toggle('locked', isLocked);
    document.getElementById('link-view').style.display='flex';
    document.getElementById('slots').style.display='none';
    if (controls) controls.style.display='none';
    document.getElementById('chooseDayBtn')?.setAttribute('disabled','true');
    document.getElementById('adminLinkBtn')?.setAttribute('disabled','true');
    document.getElementById('manualBtn')?.setAttribute('disabled','true');
    history.pushState(null,'',location.href);
    window.addEventListener('popstate',()=>{ history.pushState(null,'',location.href); });
  }

  async function loadDay(){
    titleEl.textContent=`Heute: ${currentDay}`;
    if (!linkChild) { controls.style.display='flex'; } else { controls.style.display='none'; }

    if(!SCHOOL.includes(currentDay)){ infoEl.textContent='Kein OGS-Tag. Nur Mo–Fr.'; slotsEl.innerHTML=''; return; }
    infoEl.textContent='Lade…'; slotsEl.innerHTML='';

    try{
      const timesSnap=await dbAbhol.ref(currentDay).once('value');
      const times=timesSnap.val()||{};

      if(linkChild){
        const statusNow=(await dbAbhol.ref(`abmeldungen/${dateKey()}`).once('value')).val()||{};
        const msg=await tryAutoCheckout(times,statusNow);
        return;
      }

      // ... Lade Logik für Nicht-Link-Modus (Tagesansicht) bleibt unverändert
      const isTodaySelected=(currentDay===todayName());
      let status={}, onetime={};
      if(isTodaySelected){
        [status,onetime]=await Promise.all([
          dbAbhol.ref(`abmeldungen/${dateKey()}`).once('value').then(s=>s.val()||{}),
          dbAbhol.ref(`onetime/${dateKey()}`).once('value').then(s=>s.val()||{})
        ]);
      }

      const rows=Object.entries(times).map(([name,baseTime])=>{
        const finalTime=(isTodaySelected && onetime[name]) ? onetime[name] : (baseTime||null);
        const isOnetime=isTodaySelected && !!onetime[name];
        const strike=isTodaySelected && !!status[name];
        return {name, finalTime, isOnetime, strike};
      });

      const groups={};
      rows.forEach(r=>{ const t=r.finalTime||'—'; (groups[t] ||= []).push(r); });

      const sortedTimes=Object.keys(groups).sort((a,b)=>{
        const am=parseHHMM(a), bm=parseHHMM(b);
        if(am===null && bm===null) return 0;
        if(am===null) return 1;
        if(bm===null) return -1;
        return am-bm;
      });

      if(sortedTimes.length===0){ infoEl.textContent='Keine Einträge für heute.'; return; }

      sortedTimes.forEach(t=>{
        const slot=document.createElement('div'); slot.className='slot';
        slot.innerHTML=`<h2>${t==='—'?'ohne Zeit':t+' Uhr'}</h2><ul class="names"></ul>`;
        const ul=slot.querySelector('.names');
        groups[t].sort((a,b)=>a.name.localeCompare(b.name,'de')).forEach(r=>{
          const li=document.createElement('li');
          if(r.strike) li.classList.add('strike');
          if(r.isOnetime) li.classList.add('onetime');
          li.textContent=r.name;
          ul.appendChild(li);
        });
        slotsEl.appendChild(slot);
      });

      infoEl.textContent='Fertig.';
    }catch(e){
      console.error(e);
      infoEl.textContent='Fehler beim Laden. Regeln/Verbindung prüfen.';
    }
  }

  /* === Auto-Abmeldung inkl. NEUER Sperrlogik === */
  async function tryAutoCheckout(times,status){
    const name = linkChild;
    const now = Date.now();
    const systemModeRef = dbGesamt.ref("systemmode/state");
    const kindRef = dbGesamt.ref(`kinder/${name}`);
    const linkFailsRef = dbAbhol.ref(`linkFails/${dateKey()}/${name}`);
    const SperrGrundAutomatisch = "Terminal benutzt im gesperrten Modus";
    const SperrDauer = 10 * 60 * 1000; // 10 Minuten in Millisekunden
    
    // --- 1. Globale Admin-Sperre prüfen (Priorität) ---
    const kindSnap = await kindRef.once('value');
    const kindData = kindSnap.val() || {};
    
    if (kindData.gesperrt === true) {
      const sperrBis = kindData.sperrBis || 0;
      const restZeitMs = sperrBis - now;
      const istAutomatischeSperre = kindData.sperrGrund === SperrGrundAutomatisch;
      
      let msg;

      if (restZeitMs > 0) {
        // Temporäre Sperre läuft noch
        const restMin = Math.ceil(restZeitMs / 60000);
        
        // ANGEPASSTE SPERRMELDUNG
        msg = `Dein Konto wurde gesperrt! Grund: ${kindData.sperrGrund || 'Nicht angegeben'}.<br>Du hast für **${restMin} Minute(n)** keinen Zugriff auf dein Konto.`;

      } else if (istAutomatischeSperre) {
        // Automatische Sperre ist abgelaufen: entsperren
        await kindRef.update({ gesperrt: null, sperrGrund: null, sperrBis: null });
        // Führe Checkout nach Entsperrung fort
        return continueCheckout(times, status, name);
      } else {
        // Manuelle Sperre ist aktiv (keine automatische Zeitsteuerung)
        msg = `${name}: Dein Konto ist gesperrt! Grund: ${kindData.sperrGrund || 'Nicht angegeben'}.`;
      }
      
      enterLinkMode(msg, true);
      return;
    }
    
    // --- 2. Prüfen, ob Terminal im Roten Modus ist (für Fail-Zählung) ---
    const modeSnap = await systemModeRef.once("value");
    const rawMode = modeSnap.val().value || "green";

    if (rawMode === 'red') {
      let failsSnap = await linkFailsRef.once('value');
      let fails = failsSnap.val() || [];
      
      // Filter Fails, die älter als 5 Minuten sind
      fails = fails.filter(ts => now - ts < 5 * 60 * 1000); // 5 Minuten
      fails.push(now); // Aktuellen Versuch hinzufügen
      
      if (fails.length >= 2) { // ZWEIMAL Scannen führt zur Sperre
        const sperrBis = now + SperrDauer;
        
        // Globale Sperre in dbGesamt (db1) aktivieren
        await kindRef.update({
          gesperrt: true, 
          sperrGrund: SperrGrundAutomatisch, 
          sperrBis: sperrBis // Timestamp für 10 Minuten in der Zukunft
        });
        
        // Fails zurücksetzen und sperren
        await linkFailsRef.set(null); // Setze Fails auf null, da Sperre aktiv ist
        
        // Sperrmeldung direkt nach Aktivierung
        const msg = `Dein Konto wurde gesperrt! Grund: ${SperrGrundAutomatisch}.<br>Du hast für **10 Minuten** keinen Zugriff auf dein Konto.`;
        enterLinkMode(msg, true);
        return;
      } else {
        await linkFailsRef.set(fails); // Fails speichern
        
        // ANGEPASSTE WARNUNG
        const msg = `Warnung! Nutze das Terminal nicht im gesperrten Modus. Beim nächsten Versuch wird dein Konto für 10 Minuten gesperrt.`;
        enterLinkMode(msg, true); // True für rote Hervorhebung
        return;
      }
    } // End if (rawMode === 'red')

    // --- 3. Normaler Checkout (Grün/Gelb) ---
    return continueCheckout(times, status, name);
  }

  async function continueCheckout(times, status, name) {
    const setRef=dbAbhol.ref(`abmeldungen/${dateKey()}/${name}`);

    if(!times || !times[name]) return enterLinkMode(`Unbekanntes Kind: ${name}.`);
    if(status && status[name]) return enterLinkMode(`${name}: bereits abgemeldet.`);

    const otSnap=await dbAbhol.ref(`onetime/${dateKey()}/${name}`).once('value');
    const specialTime=otSnap.val();
    const baseTime=String(times[name]);
    const t=specialTime || baseTime;
    const target=parseHHMM(t);
    const allowedFrom=target!==null ? target-2 : null;
    const now = nowMinutes();

    if(isAdmin || allowedFrom===null || now >= allowedFrom){
      try{ 
        await setRef.set(true); 
        // Falls Fehlversuch-Zähler existiert, löschen
        dbAbhol.ref(`linkFails/${dateKey()}/${name}`).set(null);
        enterLinkMode(`${name}: erfolgreich abgemeldet.`); 
      }
      catch{ enterLinkMode(`${name}: Abmeldung fehlgeschlagen.`); }
    }else{
      const wait=Math.max(0, allowedFrom-now);
      enterLinkMode(`${name}: bitte noch ${wait} Min warten.`);
    }
  }

  document.addEventListener('DOMContentLoaded',loadDay);
</script>
</body>
</html>
